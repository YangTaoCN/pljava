<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Apache Maven Doxia Site Renderer 1.6 at 2018-09-10 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>PostgreSQL PL/Java &#x2013; Optionally-built example code for XML processing with Saxon</title>
    <style type="text/css" media="all">
      @import url("../css/maven-base.css");
      @import url("../css/maven-theme.css");
      @import url("../css/site.css");
    </style>
    <link rel="stylesheet" href="../css/print.css" type="text/css" media="print" />
    <meta name="Date-Revision-yyyymmdd" content="20180910" />
    <meta http-equiv="Content-Language" content="en" />
        
        </head>
  <body class="composite">
    <div id="banner">
                        <a href="https://tada.github.io/pljava/" id="bannerLeft" title="PL/Java logo combining the PostgreSQL elephant and a Java bean">
                                                <img src="../images/pljava_logo.jpg" alt="PL/Java logo combining the PostgreSQL elephant and a Java bean" />
                </a>
                    <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
            
                    
                <div class="xleft">
        <span id="publishDate">Last Published: 2018-09-10</span>
                  &nbsp;| <span id="projectVersion">Version: 1.5.1-BETA2</span>
                      </div>
            <div class="xright">                    <a href="https://github.com/tada/pljava/wiki/" class="externalLink" title="Wiki">Wiki</a>
            |
                        <a href="https://github.com/tada/pljava/issues" class="externalLink" title="Issues">Issues</a>
            |
                        <a href="http://lists.pgfoundry.org/pipermail/pljava-dev/" class="externalLink" title="Mailing list">Mailing list</a>
            |
                        <a href="https://github.com/tada/pljava/tree/master/" class="externalLink" title="Code">Code</a>
              
                    
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
             
                    
                                <h5>Usage</h5>
                  <ul>
                  <li class="none">
                          <a href="../build/build.html" title="Building PL/Java">Building PL/Java</a>
            </li>
                  <li class="none">
                          <a href="../install/install.html" title="Installing into PostgreSQL">Installing into PostgreSQL</a>
            </li>
                  <li class="none">
                          <a href="../install/upgrade.html" title="Upgrading">Upgrading</a>
            </li>
                  <li class="none">
                          <a href="../build/package.html" title="Packaging PL/Java">Packaging PL/Java</a>
            </li>
                  <li class="none">
                          <a href="../use/use.html" title="User guide">User guide</a>
            </li>
                  <li class="none">
                          <a href="../develop/develop.html" title="Developer notes">Developer notes</a>
            </li>
          </ul>
                       <h5>Release Information</h5>
                  <ul>
                  <li class="none">
                          <a href="../releasenotes.html" title="Release notes">Release notes</a>
            </li>
          </ul>
                       <h5>Modules</h5>
                  <ul>
                  <li class="none">
                          <a href="../pljava-api/index.html" title="PL/Java API">PL/Java API</a>
            </li>
                  <li class="none">
                          <a href="../pljava/index.html" title="PL/Java backend Java code">PL/Java backend Java code</a>
            </li>
                  <li class="none">
                          <a href="../pljava-so/index.html" title="PL/Java backend native code">PL/Java backend native code</a>
            </li>
                  <li class="none">
                          <a href="../pljava-deploy/index.html" title="PL/Java Deploy">PL/Java Deploy</a>
            </li>
                  <li class="none">
                          <a href="../pljava-ant/index.html" title="PL/Java Ant tasks">PL/Java Ant tasks</a>
            </li>
                  <li class="none">
                          <a href="../pljava-examples/index.html" title="PL/Java examples">PL/Java examples</a>
            </li>
                  <li class="none">
                          <a href="../pljava-packaging/index.html" title="PL/Java packaging">PL/Java packaging</a>
            </li>
          </ul>
                       <h5>Project Documentation</h5>
                  <ul>
                                                                                                                                                                                                                                                                          <li class="collapsed">
                          <a href="../project-info.html" title="Project Information">Project Information</a>
                  </li>
          </ul>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="../images/logos/maven-feather.png" />
      </a>
                   
                    
            </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <div class="section">
<h2><a name="Optionally-built_example_code_for_XML_processing_with_Saxon"></a>Optionally-built example code for XML processing with Saxon</h2>
<p>In the source directory <tt>org/postgresql/pljava/example/saxon</tt> is example code for XML processing functions similar to <tt>XMLQUERY</tt> and <tt>XMLTABLE</tt> but using the XQuery language as the SQL/XML standard actually specifies (in contrast to the similar functions built into PostgreSQL, which support only XPath, and XPath 1.0, at that).</p>
<p>This code is not built by default, because it pulls in the sizeable <a class="externalLink" href="http://www.saxonica.com/html/products/products.html">Saxon-HE</a> library from Saxonica, and because (unlike the rest of PL/Java) it requires Java 8.</p>
<p>To include these optional functions when building the examples, be sure to use a Java 8 build environment, and add <tt>-Psaxon-examples</tt> to the <tt>mvn</tt> command line.</p>
<div class="section">
<h3><a name="Using_the_Saxon_examples"></a>Using the Saxon examples</h3>
<p>The simplest installation method is to use <tt>sqlj.install_jar</tt> twice, once to install the PL/Java examples jar in the usual way (perhaps with the name <tt>ex</tt> and with <tt>deploy =&gt; true</tt>), and once to install (perhaps with the name <tt>saxon</tt>) the Saxon-HE jar that Maven will have downloaded during the build. That jar will be found in your Maven repository (likely <tt>~/.m2/repository/</tt> unless you have directed it elsewhere) below the path <tt>net/sf/saxon</tt>.</p>
<p>Then use <tt>sqlj.set_classpath</tt> to set a path including both jars (<tt>'ex:saxon'</tt> if you used the names suggested above).</p>
<p>This is work-in-progress code, currently incomplete, and for purposes of example.</p></div>
<div class="section">
<h3><a name="Calling_XML_functions_without_SQL_syntactic_sugar"></a>Calling XML functions without SQL syntactic sugar</h3>
<p>The XML querying and <tt>XMLTABLE</tt> functions built into PostgreSQL get special treatment from the SQL parser to give them syntax that is more SQLish than an ordinary function call.</p>
<p>The functions provided here have to work as ordinary SQL user-defined functions, so calls to them can look a bit more verbose when written out in SQL, but in a way that can be recognized as a straightforward rewriting of the SQLish standard syntax.</p>
<p>For example, suppose there is a table <tt>catalog_as_xml</tt> with a single row whose <tt>x</tt> column is a (respectably sized) XML document recording the stuff in <tt>pg_catalog</tt>. It could be created like this:</p>

<div class="source">
<div class="source">
<pre>CREATE TABLE catalog_as_xml(x) AS
  SELECT schema_to_xml('pg_catalog', false, true, '');
</pre></div></div>
<div class="section">
<h4><a name="An_XMLQUERY-like_function"></a>An <tt>XMLQUERY</tt>-like function</h4>
<p>In the syntax of the SQL/XML standard, here is a query that would return an XML element representing the declaration of the function with the name <tt>numeric_avg</tt> (if PostgreSQL really had the standard <tt>XMLQUERY</tt> function built in):</p>

<div class="source">
<div class="source">
<pre>SELECT XMLQUERY('/pg_catalog/pg_proc[proname eq $FUNCNAME]'
                PASSING BY VALUE x, 'numeric_avg' AS FUNCNAME
                RETURNING CONTENT EMPTY ON EMPTY)
FROM catalog_as_xml;
</pre></div></div>
<p>It binds the &#x2018;context item&#x2019; of the query to <tt>x</tt>, and the <tt>NAME</tt> parameter to the given value, then evaluates the query and returns XML &#x201c;CONTENT&#x201d; (a tree structure with a document node at the root, but not necessarily meeting all the requirements of an XML &#x201c;DOCUMENT&#x201d;). It can be rewritten as this call to the <tt>xq_ret_content</tt> method provided here:</p>

<div class="source">
<div class="source">
<pre>SELECT javatest.xq_ret_content('/pg_catalog/pg_proc[proname eq $FUNCNAME]',
                               PASSING =&gt; p, nullOnEmpty =&gt; false)
FROM catalog_as_xml,
LATERAL (SELECT x AS &quot;.&quot;, 'numeric_avg' AS &quot;FUNCNAME&quot;) AS p;
</pre></div></div>
<p>In the rewritten form, the type of value returned is determined by which function is called, and the parameters to pass to the query are moved out to a separate <tt>SELECT</tt> that supplies their values, types, and names (with the context item now given the name &#x201c;.&#x201d;) and is passed by its alias into the query function.</p>
<p>An alert reader may notice that the example above includes a named parameter, <tt>FUNCNAME</tt>, and it is spelled in uppercase in the XQuery expression that uses it, and is spelled in uppercase <i>and quoted</i> in the sub-<tt>SELECT</tt> that supplies it. The reason is an unconditional <tt>toUppercase()</tt> in PL/Java&#x2019;s internal JDBC driver, which is not anything the JDBC standard requires, but has been there in PL/Java since 2005. For now, therefore, no matter how a parameter name is spelled in the sub-<tt>SELECT</tt>, it must appear in uppercase in the XQuery expression using it, or it will not be recognized. A future PL/Java release is highly likely to stop forcibly uppercasing the names. At that time, any code relying on the uppercasing will break. Therefore, it is wisest, until then, to call this function with all parameter names spelled in uppercase both in the SQL and in the XQuery text, and on the SQL side that requires quoting the name to avoid the conventional lowercasing done by PostgreSQL.</p>
<p>In the standard, parameters and results (of XML types) can be passed <tt>BY VALUE</tt> or <tt>BY REF</tt>, where the latter means that the same nodes will retain their XQuery node identities over calls (note that this is a meaning unrelated to what &#x201c;by value&#x201d; and &#x201c;by reference&#x201d; usually mean in PostgreSQL&#x2019;s documentation). PostgreSQL&#x2019;s implementation of the XML type provides no way for <tt>BY REF</tt> semantics to be implemented, so everything happening here happens <tt>BY VALUE</tt> implicitly, and does not need to be specified.</p></div>
<div class="section">
<h4><a name="An_XMLTABLE-like_function"></a>An <tt>XMLTABLE</tt>-like function</h4>
<p>The function <tt>xmltable</tt> here implements (much of) the standard function of the same name. Because it is the same name, it has to be either schema-qualified or double-quoted in a call to avoid confusion with the reserved word. A rewritten form of the <a class="externalLink" href="https://www.postgresql.org/docs/10/static/functions-xml.html#FUNCTIONS-XML-PROCESSING-XMLTABLE">first example in the PostgreSQL manual</a> could be:</p>

<div class="source">
<div class="source">
<pre>SELECT xmltable.*
FROM
  xmldata,

  LATERAL (SELECT data AS &quot;.&quot;, 'not specified'::text AS &quot;DPREMIER&quot;) AS p,

  &quot;xmltable&quot;('//ROWS/ROW', PASSING =&gt; p, COLUMNS =&gt; ARRAY[
   'xs:int(@id)', null, 'string(COUNTRY_NAME)',
   'string(COUNTRY_ID)', 'xs:double(SIZE[@unit eq &quot;sq_km&quot;])',
   'concat(SIZE[@unit ne &quot;sq_km&quot;], &quot; &quot;, SIZE[@unit ne &quot;sq_km&quot;]/@unit)',
   'let $e := zero-or-one(PREMIER_NAME)/string()
    return if ( empty($e) ) then $DPREMIER else $e'
  ]) AS (
   id int, ordinality int, &quot;COUNTRY_NAME&quot; text, country_id text,
   size_sq_km float, size_other text, premier_name text
  );
</pre></div></div>
<p>Again, the context item and a parameter (here the desired default value for <tt>PREMIER</tt>, passed in as the parameter <tt>DPREMIER</tt>) are supplied by a separate query producing the row <tt>p</tt> that is given as <tt>&quot;xmltable&quot;</tt>&#x2019;s <tt>PASSING</tt> argument. The result column names and types are now specified in the <tt>AS</tt> list following the function call, and the column XML Query expressions are supplied as the <tt>COLUMNS</tt> array. The array must have length equal to the result column <tt>AS</tt> list (there is no defaulting an omitted column expression to an element test using the column&#x2019;s name, as there is in the standard function). The array is allowed to have one null element, marking that column <tt>FOR ORDINALITY</tt>.</p>
<p>The parameter being passed into the XQuery expressions here, <tt>DPREMIER</tt>, is spelled in uppercase (and, on the SQL side, quoted), for the reasons explained above for the <tt>XMLQUERY</tt>-like function.</p>
<p>The explicit casts and <tt>zero-or-one</tt> will not be needed once the full automatic casting rules (for now only partially implemented) are in place. The default, as shown, is handled by passing the desired default value as a parameter and rewriting the column expression to apply it in place of an empty sequence. This lacks, for now, some functionality of the standard <tt>XMLTABLE</tt>, where the default expression can refer to other columns of the same output row.</p></div></div>
<div class="section">
<h3><a name="Minimizing_startup_time"></a>Minimizing startup time</h3>
<p>Saxon is a large library, and benefits greatly from precompilation into a memory-mappable persistent cache, using the <a href="../install/appcds.html">application class data sharing</a> feature in Oracle Java or in OpenJDK with Hotspot, or the <a href="../install/oj9vmopt.html#How_to_set_up_class_sharing_in_OpenJ9">class sharing</a> feature in OpenJDK with OpenJ9.</p>
<p>The OpenJ9 feature is simpler to set up. Because it can cache classes straight from PL/Java installed jars, the setup can be done exactly as described above, and the OpenJ9 class sharing, if enabled, will just work. OpenJ9 class-sharing setup <a href="../install/oj9vmopt.html#How_to_set_up_class_sharing_in_OpenJ9">instructions are here</a>.</p>
<p>The Hotspot <tt>AppCDS</tt> feature is more work to set up, and can only cache classes on the JVM system classpath, so the Saxon jar would have to be installed on the filesystem and named in <tt>pljava.classpath</tt> instead of simply installing it in PL/Java. It also needs to be stripped of its <tt>jarsigner</tt> metadata, which the Hotspot <tt>AppCDS</tt> can&#x2019;t handle. Hotspot <tt>AppCDS</tt> setup <a href="../install/appcds.html">general instructions are here</a>, and specific details for setting up this example for <tt>AppCDS</tt> can be found on the <a class="externalLink" href="https://github.com/tada/pljava/wiki/Performance-tuning">performance-tuning wiki page</a> in the section devoted to it.</p>
<p>A comparison shown on that performance-tuning page appears to give Hotspot a significant advantage for a Saxon-heavy workload, so the more complex Hotspot setup may remain worthwhile as long as that comparison holds.</p>
<p>The <tt>AppCDS</tt> feature in Oracle Java is still (when last checked) a commercial feature, not to be used in production without a specific license from Oracle. OpenJDK, as of Java 10, ships Hotspot with the same feature included, without the encumbrance.</p></div></div>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
              Copyright &#169;                    2003&#x2013;2018
                        <a href="http://tada.se/eng/">Tada AB</a>.
            All rights reserved.      
                    
                  </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
